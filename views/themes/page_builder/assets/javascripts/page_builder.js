"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(t){function e(n,i){this.$element=t(n),this.options=t.extend({},e.DEFAULTS,t.isPlainObject(i)&&i),this.init()}var n=t("body"),i="qor.chooser.sortable",o="enable."+i,a="click."+i,s="disable."+i,r=".select2-selection__choice",d=".select2-container",l=".select2-search__field",c=".qor-dragable",u=".qor-dragable__list",h=".qor-dragable__list-handle",f=".qor-dragable__list-delete",m=".qor-dragable__list-data",p=".qor-dragable__button-add",b=".qor-bottomsheets",y="sortable-select-many-loaded",v="qor-bottomsheets__select-many",_="is_selected",g='[data-select-modal="many_sortable"]';return e.prototype={constructor:e,init:function(){var e=this.$element,n=e.data(),i=e.parents(c),o=e.data("placeholder"),a=this,s={minimumResultsForSearch:8,dropdownParent:e.parent()};this.$selector=i.find(m),this.$sortableList=i.find(u),this.$parent=i;var p=i.find(u)[0];this.sortable=window.Sortable.create(p,{animation:150,handle:h,filter:f,dataIdAttr:"data-index",onFilter:function(e){var n=t(e.item),i=n.data("index");n.remove(),a.removeItemsFromList(i)},onUpdate:function(){a.renderOption()}}),n.remoteData&&(s.ajax=t.fn.select2.ajaxCommonOptions(n),s.templateResult=function(n){var i=e.parents(".qor-field").find('[name="select2-result-template"]');return t.fn.select2.ajaxFormatResult(n,i)},s.templateSelection=function(n){if(n.loading)return n.text;var i=e.parents(".qor-field").find('[name="select2-selection-template"]');return t.fn.select2.ajaxFormatResult(n,i)}),e.is("select")&&(e.on("change",function(){setTimeout(function(){i.find(r).hide()},1),t(l).attr("placeholder",o)}).on("select2:select",function(t){console.log(t.params.data),a.addItems(t.params.data)}).on("select2:unselect",function(t){a.removeItems(t.params.data)}),e.select2(s),i.find(d).hide(),i.find(r).hide(),t(l).attr("placeholder",o)),this.bind()},bind:function(){this.$parent.on(a,p,this.show.bind(this)),t(document).on(a,g,this.openSortable.bind(this))},unbind:function(){this.$parent.off(a,p,this.show),t(document).off(a,g,this.openSortable)},openSortable:function(e){var i=t(e.target).data();this.BottomSheets=n.data("qor.bottomsheets"),this.selectedIconTmpl=t('[name="select-many-selected-icon"]').html(),i.ingoreSubmit=!0,i.url=i.selectListingUrl,i.selectDefaultCreating&&(i.url=i.selectCreatingUrl),this.BottomSheets.open(i,this.handleBottomSelect.bind(this))},show:function(){var t=this.$parent.find(d);t.show(),this.$parent.find(p).hide(),setTimeout(function(){t.find(l).click()},100)},handleBottomSelect:function(){var e=t(b),n={onSelect:this.onSelectResults.bind(this),onSubmit:this.onSubmitResults.bind(this)};e.qorSelectCore(n).addClass(v),this.initItems()},onSelectResults:function(e){var n=e.$clickElement,i=n.find("td:first"),o=this.collectData(e);t(u).find('li[data-index="'+o.id+'"]').length?(this.removeItems(o),n.removeClass(_),i.find(".qor-select__select-icon").remove()):(this.addItems(o),n.addClass(_),i.append(this.selectedIconTmpl))},onSubmitResults:function(t){this.addItems(this.collectData(t),!0)},collectData:function(t){var e=this.$element.data("remote-data-primary-key"),n={};return n.id=t[e]||t.primaryKey||t.Id||t.ID,n.value=t.Name||t.text||t.Text||t.Title||t.Code||n.id,n},initItems:function(){var e,n=t(b).find("tbody tr"),i=this.selectedIconTmpl,o=[],a=this.$sortableList.find("[data-index]");a.each(function(){o.push(t(this).data("index"))}),n.each(function(){var n=t(this),a=n.find("td:first");e=n.data().primaryKey,"-1"!=o.indexOf(e)&&(n.addClass(_),a.append(i))})},renderItem:function(t){return window.Mustache.render(e.LIST_HTML,t)},renderOption:function(){var t=this.sortable.toArray(),n=this.$parent.find(m);n.empty(),window._.each(t,function(t){n.append(window.Mustache.render(e.OPTION_HTML,{value:t}))})},removeItems:function(e){t(u).find('li[data-index="'+e.id+'"]').remove(),this.renderOption()},removeItemsFromList:function(){this.renderOption()},addItems:function(t,e){this.$sortableList.append(this.renderItem(t)),this.renderOption(),e&&this.BottomSheets.hide()},destroy:function(){this.sortable.destroy(),this.unbind(),this.$element.select2("destroy").removeData(i)}},e.DEFAULTS={},e.LIST_HTML='<li data-index="[[id]]" data-value="[[value]]"><span>[[value]]</span><div><i class="material-icons qor-dragable__list-delete">clear</i><i class="material-icons qor-dragable__list-handle">drag_handle</i></div></li>',e.OPTION_HTML='<option selected value="[[value]]"></option>',e.plugin=function(n){return this.each(function(){var o,a=t(this),s=a.data(i);if(!s){if(/destroy/.test(n))return;a.data(i,s=new e(this,n))}"string"==typeof n&&t.isFunction(o=s[n])&&o.apply(s)})},t(function(){var n='[data-toggle="qor.chooser.sortable"]';t("body").data(y)||(t("body").data(y,!0),t(document).on(s,function(i){e.plugin.call(t(n,i.target),"destroy")}).on(o,function(i){e.plugin.call(t(n,i.target))}).triggerHandler(o))}),e});